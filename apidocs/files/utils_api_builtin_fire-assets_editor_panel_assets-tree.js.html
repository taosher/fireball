<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>utils/api/builtin/fire-assets/editor/panel/assets-tree.js - Fireball Engine API</title>
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="../assets/vendor/yui-min.js"></script>
</head>
<body>

<div id="doc">
    <header class="main-header">
        <div class="content">
            <div class="project-title">
                    <a href="http://docs-zh.fireball-x.com"><img class="logo" src="http://docs-zh.fireball-x.com/images/logo.png" title="Fireball Engine API"></a>
                    <h1 class="project-name">Fireball Engine API</h1> <span class="project-version">0.3.0</span>
                    <p class="description">Fireball is the game engine for the future.</p>
            </div>
            <ul class="jump-links">
                <li><a href="#index" class="index-jump-link">index</a></li>
                <li><a href="#top" class="top-jump-link">top</a></li>
            </ul>
        </div>
    </header>
    <div id="bd" class="main-body">

        <div id="docs-sidebar" class="sidebar apidocs">
            <div id="api-list">
                <div id="api-tabview" class="tabview">
                    <ul class="tabs">
                        <li><a href="#api-classes">Classes</a></li>
                        <li><a href="#api-modules">Modules</a></li>
                    </ul>
            
                    <div id="api-tabview-filter">
                        <input type="search" id="api-filter" placeholder="Type to filter APIs">
                    </div>
            
                    <div id="api-tabview-panel">
                        <ul id="api-classes" class="apis classes">
                            <li><a class="type" href="../classes/_CallbacksHandler.html">_CallbacksHandler</a></li>
                            <li><a class="type" href="../classes/_DeserializeInfo.html">_DeserializeInfo</a></li>
                            <li><a class="type" href="../classes/_ObjectFlags.html">_ObjectFlags</a></li>
                            <li><a class="type" href="../classes/_Runtime.RenderContext.html">_Runtime.RenderContext</a></li>
                            <li><a class="type" href="../classes/Asset.html">Asset</a></li>
                            <li><a class="type" href="../classes/AssetBundleBase.html">AssetBundleBase</a></li>
                            <li><a class="type" href="../classes/AssetLibrary.html">AssetLibrary</a></li>
                            <li><a class="type" href="../classes/AudioClip.html">AudioClip</a></li>
                            <li><a class="type" href="../classes/AudioSource.html">AudioSource</a></li>
                            <li><a class="type" href="../classes/BitmapFont.html">BitmapFont</a></li>
                            <li><a class="type" href="../classes/BitmapText.html">BitmapText</a></li>
                            <li><a class="type" href="../classes/CallbacksInvoker.html">CallbacksInvoker</a></li>
                            <li><a class="type" href="../classes/Camera.html">Camera</a></li>
                            <li><a class="type" href="../classes/Color.html">Color</a></li>
                            <li><a class="type" href="../classes/Component.html">Component</a></li>
                            <li><a class="type" href="../classes/ContentStrategyType.html">ContentStrategyType</a></li>
                            <li><a class="type" href="../classes/Editor.html">Editor</a></li>
                            <li><a class="type" href="../classes/Engine.html">Engine</a></li>
                            <li><a class="type" href="../classes/Entity.html">Entity</a></li>
                            <li><a class="type" href="../classes/EqualToFrame.html">EqualToFrame</a></li>
                            <li><a class="type" href="../classes/Event.html">Event</a></li>
                            <li><a class="type" href="../classes/EventTarget.html">EventTarget</a></li>
                            <li><a class="type" href="../classes/Fire.html">Fire</a></li>
                            <li><a class="type" href="../classes/FixedHeight.html">FixedHeight</a></li>
                            <li><a class="type" href="../classes/FObject.html">FObject</a></li>
                            <li><a class="type" href="../classes/FontType.html">FontType</a></li>
                            <li><a class="type" href="../classes/HashObject.html">HashObject</a></li>
                            <li><a class="type" href="../classes/Input.html">Input</a></li>
                            <li><a class="type" href="../classes/Intersection.html">Intersection</a></li>
                            <li><a class="type" href="../classes/JS.html">JS</a></li>
                            <li><a class="type" href="../classes/KeyboardEvent.html">KeyboardEvent</a></li>
                            <li><a class="type" href="../classes/LoadManager.html">LoadManager</a></li>
                            <li><a class="type" href="../classes/Math.html">Math</a></li>
                            <li><a class="type" href="../classes/Matrix23.html">Matrix23</a></li>
                            <li><a class="type" href="../classes/ModifierKeyStates.html">ModifierKeyStates</a></li>
                            <li><a class="type" href="../classes/MouseEvent.html">MouseEvent</a></li>
                            <li><a class="type" href="../classes/NoScale.html">NoScale</a></li>
                            <li><a class="type" href="../classes/Path.html">Path</a></li>
                            <li><a class="type" href="../classes/Playable.html">Playable</a></li>
                            <li><a class="type" href="../classes/Rect.html">Rect</a></li>
                            <li><a class="type" href="../classes/Renderer.html">Renderer</a></li>
                            <li><a class="type" href="../classes/Resources.html">Resources</a></li>
                            <li><a class="type" href="../classes/ResourcesBundle.html">ResourcesBundle</a></li>
                            <li><a class="type" href="../classes/Screen.html">Screen</a></li>
                            <li><a class="type" href="../classes/Screen.ContainerStrategy.html">Screen.ContainerStrategy</a></li>
                            <li><a class="type" href="../classes/Screen.ContentStrategy.html">Screen.ContentStrategy</a></li>
                            <li><a class="type" href="../classes/Sprite.html">Sprite</a></li>
                            <li><a class="type" href="../classes/SpriteAnimation.html">SpriteAnimation</a></li>
                            <li><a class="type" href="../classes/SpriteAnimationClip.html">SpriteAnimationClip</a></li>
                            <li><a class="type" href="../classes/SpriteAnimationClip.StopAction.html">SpriteAnimationClip.StopAction</a></li>
                            <li><a class="type" href="../classes/SpriteAnimationClip.WrapMode.html">SpriteAnimationClip.WrapMode</a></li>
                            <li><a class="type" href="../classes/SpriteAnimationState.html">SpriteAnimationState</a></li>
                            <li><a class="type" href="../classes/SpriteRenderer.html">SpriteRenderer</a></li>
                            <li><a class="type" href="../classes/TextAlign.html">TextAlign</a></li>
                            <li><a class="type" href="../classes/TextAnchor.html">TextAnchor</a></li>
                            <li><a class="type" href="../classes/Texture.html">Texture</a></li>
                            <li><a class="type" href="../classes/Texture.FilterMode.html">Texture.FilterMode</a></li>
                            <li><a class="type" href="../classes/Texture.WrapMode.html">Texture.WrapMode</a></li>
                            <li><a class="type" href="../classes/Time.html">Time</a></li>
                            <li><a class="type" href="../classes/Transform.html">Transform</a></li>
                            <li><a class="type" href="../classes/Vec2.html">Vec2</a></li>
                        </ul>
            
                        <ul id="api-modules" class="apis modules">
                            <li><a class="module" href="../modules/Editor.html">Editor</a></li>
                            <li><a class="module" href="../modules/Fire.html">Fire</a></li>
                            <li><a class="module" href="../modules/Math.html">Math</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div id="docs-main" class="apidocs">
            <div class="content container">
                <h1 class="file-heading">File: utils/api/builtin/fire-assets/editor/panel/assets-tree.js</h1>
                
                <div class="file">
                    <pre class="code prettyprint linenums">
                /**
                 * @module Fire
                 * @class Fire
                 */
                var Path = require(&#x27;fire-path&#x27;);
                var Url = require(&#x27;fire-url&#x27;);
                
                function _isTexture ( extname ) {
                    return extname === &#x27;.png&#x27; || extname === &#x27;.jpg&#x27;;
                }
                
                function _newAssetsItem ( url, type, id, parentEL ) {
                    var newEL = new AssetsItem();
                    newEL.isRoot = type === &#x27;root&#x27;;
                    newEL.isFolder = (type === &#x27;folder&#x27; || newEL.isRoot);
                    newEL.isSubAsset = !parentEL.isFolder;
                
                    var extname = &quot;&quot;;
                    var basename = Url.basename(url);
                
                    if ( !newEL.isFolder ) {
                        extname = Url.extname(url);
                        basename = Url.basename(url, extname);
                    }
                
                    var img;
                
                    newEL.extname = extname;
                    type = type || extname.toLowerCase();
                    switch ( type ) {
                    case &#x27;root&#x27;:
                        newEL.setIcon(&#x27;db&#x27;);
                        break;
                
                    case &#x27;folder&#x27;:
                        newEL.setIcon(&#x27;folder&#x27;);
                        break;
                
                    case &#x27;.fire&#x27;:
                        newEL.setIcon(&#x27;fire&#x27;);
                        break;
                
                    case &#x27;.js&#x27;:
                        newEL.setIcon(&#x27;js&#x27;);
                        break;
                
                    case &#x27;.coffee&#x27;:
                        newEL.setIcon(&#x27;co&#x27;);
                        break;
                
                    case &#x27;.ts&#x27;:
                        newEL.setIcon(&#x27;ts&#x27;);
                        break;
                
                    case &#x27;.txt&#x27;:
                        newEL.setIcon(&#x27;txt&#x27;);
                        break;
                
                    case &#x27;.html&#x27;:
                    case &#x27;.htm&#x27;:
                    case &#x27;.xml&#x27;:
                    case &#x27;.json&#x27;:
                        newEL.setIcon(&#x27;html&#x27;);
                        break;
                
                    case &#x27;.css&#x27;:
                    case &#x27;.less&#x27;:
                    case &#x27;.styl&#x27;:
                        newEL.setIcon(&#x27;css&#x27;);
                        break;
                
                    case &#x27;.anim&#x27;:
                        newEL.setIcon(&#x27;anim&#x27;);
                        break;
                
                    case &#x27;.sprite&#x27;:
                        newEL.setIcon(&#x27;sprite&#x27;);
                        break;
                
                    case &#x27;.fnt&#x27;:
                    case &#x27;.bmf&#x27;:
                    case &#x27;.bmfont&#x27;:
                        newEL.setIcon(&#x27;bmfont&#x27;);
                        break;
                
                    case &#x27;.atlas&#x27;:
                        newEL.setIcon(&#x27;atlas&#x27;);
                        break;
                
                    case &#x27;.mp3&#x27;:
                    case &#x27;.wav&#x27;:
                    case &#x27;.ogg&#x27;:
                        newEL.setIcon(&#x27;audio&#x27;);
                        break;
                
                    case &#x27;.png&#x27;:
                    case &#x27;.jpg&#x27;:
                        img = new Image();
                        img.src = &#x27;uuid://&#x27; + id + &quot;?thumb&quot;;
                        newEL.setIcon(img);
                        break;
                
                    case &#x27;.asset&#x27;:
                        newEL.setIcon(&#x27;fa fa-cube&#x27;);
                        break;
                
                    default:
                        newEL.setIcon(&#x27;fa fa-question-circle&#x27;);
                        break;
                    }
                
                    this.initItem(newEL, basename, id, parentEL);
                    return newEL;
                }
                
                function _getNameCollisions ( target, list ) {
                
                    var nodes = target.childNodes;
                
                    var nodesLen = nodes.length;
                    var len = list.length;
                    var i,j;
                    var name;
                    var node;
                    var collisions = [];
                
                    for(i = 0; i &lt; len; i++) {
                        name = list[i];
                
                        for(j = 0; j &lt; nodesLen; j++) {
                
                            node = nodes[j];
                            if (node.name + node.extname === name) {
                                collisions.push(node);
                            }
                
                        }
                    }
                
                    return collisions;
                }
                
                function _addCustomAssetMenu(target, template) {
                    function findMenu(menuArray, label) {
                        for (var i = 0; i &lt; menuArray.length; i++) {
                            if (menuArray[i].label === label) {
                                return menuArray[i];
                            }
                        }
                        return null;
                    }
                
                    function onclick() {
                        var contextSelection = Editor.Selection.contextAssets;
                        if (contextSelection.length &gt; 0) {
                            var targetEL = target.idToItem[contextSelection[0]];
                            if (!targetEL.isFolder) {
                                targetEL = targetEL.parentElement;
                            }
                            var url = target.getUrl(targetEL);
                            var newAsset = new item.customAsset();
                            var newAssetUrl = Url.join(url, fileName + &#x27;.asset&#x27;);
                            Editor.AssetDB.generateUniqueUrl( newAssetUrl, function ( uniqueUrl ) {
                                target._focusUrl = uniqueUrl;
                                Editor.AssetDB.save( uniqueUrl, Editor.serialize(newAsset) );
                            }.bind(target));
                        }
                    }
                
                    // Custom Asset Menu Item
                    var items = Fire._customAssetMenuItems;
                    for (var i = 0; i &lt; items.length; i++) {
                        var item = items[i];
                        var subPathes = item.menuPath.split(&#x27;/&#x27;);
                        var fileName = subPathes.length &gt; 0 ? subPathes[subPathes.length - 1] : subPathes[0];
                        if (fileName === &quot;&quot;) {
                            Fire.error(&#x27;Invalid custom asset menu path: &#x27; + item.menuPath);
                            continue;
                        }
                        var prio = item.priority || 0;
                        // enumerate menu path
                        var newMenu = null;
                        for (var p = 0, parent = template; p &lt; subPathes.length; p++) {
                            var label = subPathes[p];
                            if (!label) {
                                continue;
                            }
                            var parentMenuArray = parent === template ? template : parent.submenu;
                            var menu;
                            if (parentMenuArray) {
                                if (parentMenuArray.length &gt; 0) {
                                    menu = findMenu(parentMenuArray, label);
                                }
                                if (menu) {
                                    if (menu.submenu) {
                                        parent = menu;
                                        continue;
                                    }
                                    else {
                                        Fire.error(&#x27;Custom Asset menu path %s conflict&#x27;, item.menuPath);
                                        break;
                                    }
                                }
                            }
                            // create
                            newMenu = {
                                label: label,
                            };
                            if (!parentMenuArray) {
                                parent.submenu = [newMenu];
                            }
                            else {
                                //parentMenuArray.splice(3, 0, newMenu);
                                parentMenuArray.push(newMenu);
                            }
                            parent = newMenu;
                        }
                        if (newMenu &amp;&amp; !newMenu.submenu) {
                            newMenu.click = onclick;
                        }
                        else {
                            Fire.error(&#x27;Invalid custom asset menu path: &#x27; + item.menuPath);
                        }
                    }
                }
                
                
                Polymer({
                    created: function () {
                        this.super();
                
                        this.contextmenu = null;
                
                        // dragging
                        this.curDragoverEL = null;
                        this.lastDragoverEL = null;
                        this.dragenterCnt = 0;
                
                        // confliction
                        this.confliction = [];
                
                        this._focusUrl = null;
                    },
                
                    ready: function () {
                        this.super();
                
                        this.addEventListener( &quot;dragenter&quot;, function (event) {
                            ++this.dragenterCnt;
                        }, true);
                
                        this.addEventListener( &quot;dragleave&quot;, function (event) {
                            --this.dragenterCnt;
                            if ( this.dragenterCnt === 0 ) {
                                this.resetDragState();
                            }
                        }, true);
                    },
                
                    getCreateMenuTemplate: function () {
                        return [
                            // New Folder
                            {
                                label: &#x27;New Folder&#x27;,
                                click: function () {
                                    var url = &quot;assets://&quot;;
                                    var contextSelection = Editor.Selection.contextAssets;
                                    if ( contextSelection.length &gt; 0 ) {
                                        var targetEL = this.idToItem[contextSelection[0]];
                                        if ( !targetEL.isFolder )
                                            targetEL = targetEL.parentElement;
                                        url = this.getUrl(targetEL);
                                    }
                
                                    var newAssetUrl = Url.join( url, &#x27;New Folder&#x27; );
                                    Editor.AssetDB.generateUniqueUrl( newAssetUrl, function ( uniqueUrl ) {
                                        this._focusUrl = uniqueUrl;
                                        Editor.AssetDB.newFolder( uniqueUrl );
                                    }.bind(this));
                                }.bind(this)
                            },
                
                            { type: &#x27;separator&#x27; },
                
                            // New Script
                            {
                                label: &#x27;New Script&#x27;,
                                click: function () {
                                    var url = &quot;assets://&quot;;
                                    var contextSelection = Editor.Selection.contextAssets;
                                    if ( contextSelection.length &gt; 0 ) {
                                        var targetEL = this.idToItem[contextSelection[0]];
                                        if ( !targetEL.isFolder )
                                            targetEL = targetEL.parentElement;
                                        url = this.getUrl(targetEL);
                                    }
                
                                    var newAssetUrl = Url.join( url, &#x27;NewComponent.js&#x27; );
                                    Editor.AssetDB.generateUniqueUrl( newAssetUrl, function ( uniqueUrl ) {
                                        this._focusUrl = uniqueUrl;
                                        Editor.AssetDB.newScript( uniqueUrl, &quot;simple-component&quot; );
                                    }.bind(this));
                                }.bind(this)
                            },
                
                            { type: &#x27;separator&#x27; },
                
                            // New Scene
                            {
                                label: &#x27;New Scene&#x27;,
                                click: function () {
                                    var url = &quot;assets://&quot;;
                                    var contextSelection = Editor.Selection.contextAssets;
                                    if ( contextSelection.length &gt; 0 ) {
                                        var targetEL = this.idToItem[contextSelection[0]];
                                        if ( !targetEL.isFolder )
                                            targetEL = targetEL.parentElement;
                                        url = this.getUrl(targetEL);
                                    }
                
                                    var newAsset = new Fire._Scene();
                                    var camera = newAsset.addEntity(&#x27;Main Camera&#x27;);
                                    camera.addComponent(Fire.Camera);
                
                                    var newAssetUrl = Url.join( url, &#x27;New Scene.fire&#x27; );
                                    Editor.AssetDB.generateUniqueUrl( newAssetUrl, function ( uniqueUrl ) {
                                        this._focusUrl = uniqueUrl;
                                        Editor.AssetDB.save( uniqueUrl, Editor.serialize(newAsset) );
                                    }.bind(this));
                                }.bind(this)
                            },
                
                            // New Atlas
                            {
                                label: &#x27;New Atlas&#x27;,
                                click: function () {
                                    var url = &quot;assets://&quot;;
                                    var contextSelection = Editor.Selection.contextAssets;
                                    if ( contextSelection.length &gt; 0 ) {
                                        var targetEL = this.idToItem[contextSelection[0]];
                                        if ( !targetEL.isFolder )
                                            targetEL = targetEL.parentElement;
                                        url = this.getUrl(targetEL);
                                    }
                
                                    var newAsset = new Fire.Atlas();
                                    var newAssetUrl = Url.join( url, &#x27;New Atlas.atlas&#x27; );
                                    Editor.AssetDB.generateUniqueUrl( newAssetUrl, function ( uniqueUrl ) {
                                        this._focusUrl = uniqueUrl;
                                        Editor.AssetDB.save( uniqueUrl, Editor.serialize(newAsset) );
                                    }.bind(this));
                                }.bind(this)
                            },
                
                            // New Sprite (Standalone)
                            {
                                label: &#x27;New Sprite (Standalone)&#x27;,
                                visible: Editor.isDev,
                                click: function () {
                                    var targetEL = null;
                                    var contextSelection = Editor.Selection.contextAssets;
                                    if ( contextSelection.length &gt; 0 ) {
                                        targetEL = this.idToItem[contextSelection[0]];
                                    }
                
                                    if ( targetEL &amp;&amp; _isTexture(targetEL.extname) ) {
                                        var textureName = targetEL.name;
                
                                        Fire.AssetLibrary.loadAssetInEditor ( targetEL.userId, function ( error, asset ) {
                                            var newAsset = new Fire.Sprite();
                                            newAsset.texture = asset;
                                            newAsset.width = asset.width;
                                            newAsset.height = asset.height;
                
                                            var url = this.getUrl(targetEL.parentElement);
                                            var newAssetUrl = Url.join( url, textureName + &#x27;.sprite&#x27; );
                                            Editor.AssetDB.generateUniqueUrl( newAssetUrl, function ( uniqueUrl ) {
                                                this._focusUrl = uniqueUrl;
                                                Editor.AssetDB.save( uniqueUrl, Editor.serialize(newAsset) );
                                            }.bind(this));
                                        }.bind(this) );
                                    }
                                    else {
                                        Fire.warn( &quot;Can not create sprite from non-texture element, please select a texture first.&quot; );
                                    }
                                }.bind(this)
                            },
                
                            { type: &#x27;separator&#x27; },
                        ];
                    },
                
                    createContextMenu: function () {
                        var template = [
                            // Create
                            {
                                label: &#x27;Create&#x27;,
                                submenu: this.getCreateMenuTemplate(),
                            },
                
                            // =====================
                            { type: &#x27;separator&#x27; },
                
                            // Rename
                            {
                                label: &#x27;Rename&#x27;,
                                click: function () {
                                    var contextSelection = Editor.Selection.contextAssets;
                                    if ( contextSelection.length &gt; 0 ) {
                                        var targetEL = this.idToItem[contextSelection[0]];
                                        this.rename(targetEL);
                                    }
                                }.bind(this),
                            },
                
                            // Delete
                            {
                                label: &#x27;Delete&#x27;,
                                click: function () {
                                    var contextSelection = Editor.Selection.contextAssets;
                                    var elements = this.getToplevelElements(contextSelection);
                                    for (var i = 0; i &lt; elements.length; i++) {
                                        Editor.AssetDB.delete(this.getUrl(elements[i]));
                                    }
                                }.bind(this),
                            },
                
                            // Reimport
                            {
                                label: &#x27;Reimport&#x27;,
                                click: function () {
                                    var contextSelection = Editor.Selection.contextAssets;
                                    if ( contextSelection.length &gt; 0 ) {
                                        var selectedItemEl = this.idToItem[contextSelection[0]];
                                        var url = this.getUrl(selectedItemEl);
                
                                        // remove childnodes
                                        if (selectedItemEl.isFolder) {
                                            while (selectedItemEl.firstChild) {
                                                selectedItemEl.removeChild(selectedItemEl.firstChild);
                                            }
                                            selectedItemEl.foldable = false;
                                        }
                                        Editor.AssetDB.reimport(url);
                                    }
                                }.bind(this)
                            },
                
                            // =====================
                            { type: &#x27;separator&#x27; },
                
                            // Show in finder
                            {
                                label: &#x27;Show in &#x27; + (Fire.isWin32 ? &#x27;Explorer&#x27; : &#x27;Finder&#x27;),
                                click: function () {
                                    var contextSelection = Editor.Selection.contextAssets;
                                    if ( contextSelection.length &gt; 0 ) {
                                        var targetEL = this.idToItem[contextSelection[0]];
                                        Editor.AssetDB.explore(this.getUrl(targetEL));
                                    }
                                }.bind(this)
                            },
                
                            // Show in library
                            {
                                label: &#x27;Show in Library&#x27;,
                                click: function () {
                                    var contextSelection = Editor.Selection.contextAssets;
                                    if ( contextSelection.length &gt; 0 ) {
                                        var targetEL = this.idToItem[contextSelection[0]];
                                        Editor.AssetDB.exploreLib(this.getUrl(targetEL));
                                    }
                                }.bind(this)
                            },
                
                            // Print uuid
                            {
                                label: &#x27;Show Uuid&#x27;,
                                click: function () {
                                    var contextSelection = Editor.Selection.contextAssets;
                                    for ( var i = 0; i &lt; contextSelection.length; ++i ) {
                                        var targetEL = this.idToItem[contextSelection[i]];
                                        Fire.log( targetEL.userId );
                                    }
                                }.bind(this)
                            },
                        ];
                
                        var create = template[0].submenu;
                        _addCustomAssetMenu(this, create);
                
                        var Remote = require(&#x27;remote&#x27;);
                        var Menu = Remote.require(&#x27;menu&#x27;);
                
                        this.contextmenu = Menu.buildFromTemplate(template);
                    },
                
                    browse: function ( url ) {
                        var rootEL = _newAssetsItem.call(this, url, &#x27;root&#x27;, Editor.UUID.AssetsRoot, this);
                        rootEL.folded = false;
                
                        Editor.AssetDB.deepQuery(url, function ( results ) {
                            for ( var i = 0; i &lt; results.length; ++i ) {
                                var info = results[i];
                                this.newItem( info.url, info.uuid, info.parentUuid, info.isDir );
                            }
                            this.fire(&#x27;restore-collapses&#x27;);
                        }.bind(this));
                    },
                
                    newItem: function ( url, id, parentId, isDirectory ) {
                        var parentEL = this.idToItem[parentId];
                        if ( !parentEL ) {
                            Fire.warn(&#x27;Can not find element for &#x27; + parentId + &quot; when import &quot; + url);
                            return;
                        }
                        var type = isDirectory ? &#x27;folder&#x27; : &#x27;&#x27;;
                        var newEL = _newAssetsItem.call(this, url, type, id, parentEL);
                
                        if ( this._focusUrl === url ) {
                            this._focusUrl = null;
                            this.expand(newEL.userId,true);
                            this.scrollToItem(newEL);
                            Editor.Selection.selectAsset(newEL.userId, true, true);
                        }
                    },
                
                    moveItem: function ( id, destUrl, destDirId ) {
                        var srcEL = this.idToItem[id];
                        if ( !srcEL ) {
                            Fire.warn( &#x27;Can not find source element: &#x27; + id );
                            return;
                        }
                
                        // rename it first
                        var destExtname = Path.extname(destUrl);
                        var destBasename = Path.basename(destUrl, destExtname);
                        srcEL.extname = destExtname;
                        srcEL.name = destBasename;
                
                        // insert it
                        this.setItemParentById(id, destDirId);
                
                        // expand parent
                        var parentEL = this.idToItem[destDirId];
                        if ( parentEL.isFolder ) {
                            parentEL.folded = false;
                        }
                    },
                
                    deleteSelection: function () {
                        var elements = this.getToplevelElements(Editor.Selection.assets);
                        for (var i = 0; i &lt; elements.length; i++) {
                            Editor.AssetDB.delete(this.getUrl(elements[i]));
                        }
                    },
                
                    getUrl: function ( element ) {
                        if ( element.isRoot ) {
                            return element.name + &quot;://&quot;;
                        }
                
                        var url = element.name + element.extname;
                        var parentEL = element.parentElement;
                        while ( parentEL instanceof AssetsItem ) {
                            if ( parentEL.isRoot ) {
                                url = parentEL.name + &quot;://&quot; + url;
                                break;
                            }
                            else {
                                url = Url.join( parentEL.name + parentEL.extname, url );
                                parentEL = parentEL.parentElement;
                            }
                        }
                        return url;
                    },
                
                    highlightBorder: function ( item ) {
                        if ( item &amp;&amp; item instanceof AssetsItem ) {
                            var style = this.$.highlightBorder.style;
                            style.display = &quot;block&quot;;
                            style.left = (item.offsetLeft-2) + &quot;px&quot;;
                            style.top = (item.offsetTop-1) + &quot;px&quot;;
                            style.width = (item.offsetWidth+4) + &quot;px&quot;;
                            style.height = (item.offsetHeight+3) + &quot;px&quot;;
                
                            item.highlighted = true;
                        }
                    },
                
                    highlightInsert: function ( item, parentEL, position ) {
                        var style = this.$.insertLine.style;
                        if ( item === this ) {
                            item = this.firstChild;
                        }
                
                        if ( item === parentEL ) {
                            style.display = &quot;none&quot;;
                        }
                        else if ( item &amp;&amp; parentEL ) {
                            style.display = &quot;block&quot;;
                            style.left = parentEL.offsetLeft + &quot;px&quot;;
                            if ( position === &#x27;before&#x27; )
                                style.top = (item.offsetTop) + &quot;px&quot;;
                            else
                                style.top = (item.offsetTop+item.offsetHeight) + &quot;px&quot;;
                            style.width = parentEL.offsetWidth + &quot;px&quot;;
                            style.height = &quot;0px&quot;;
                        }
                    },
                
                    highlightConflicts: function ( items ) {
                        for ( var i = 0; i &lt; items.length; ++i ) {
                            var item = items[i];
                            if ( item.conflicted === false ) {
                                item.conflicted = true;
                                this.confliction.push(item);
                            }
                        }
                
                        if ( this.curDragoverEL ) {
                            this.curDragoverEL.invalid = true;
                        }
                
                        this.$.highlightBorder.setAttribute(&#x27;invalid&#x27;,&#x27;&#x27;);
                    },
                
                    cancelHighligting: function () {
                        if ( this.curDragoverEL ) {
                            this.curDragoverEL.highlighted = false;
                            this.$.highlightBorder.style.display = &quot;none&quot;;
                            this.$.insertLine.style.display = &quot;none&quot;;
                        }
                    },
                
                    cancelConflictsHighliting: function () {
                        for ( var i = 0; i &lt; this.confliction.length; ++i ) {
                            this.confliction[i].conflicted = false;
                        }
                        this.confliction = [];
                        if ( this.curDragoverEL ) {
                            this.curDragoverEL.invalid = false;
                            this.$.highlightBorder.removeAttribute(&#x27;invalid&#x27;);
                        }
                    },
                
                    resetDragState: function () {
                        this.cancelHighligting();
                        this.cancelConflictsHighliting();
                
                        this.curDragoverEL = null;
                        this.lastDragoverEL = null;
                        this.dragenterCnt = 0;
                    },
                
                    moveAssets: function ( targetEL, assets ) {
                        var elements = this.getToplevelElements(assets);
                        var targetUrl = this.getUrl(targetEL);
                
                        for ( var i = 0; i &lt; elements.length; ++i ) {
                            var el = elements[i];
                
                            // do nothing if we already here
                            if ( el === targetEL || el.parentElement === targetEL )
                                continue;
                
                            if ( el.contains(targetEL) === false ) {
                                var srcUrl = this.getUrl(el);
                                var destUrl = Url.join( targetUrl, el.name + el.extname );
                                Editor.AssetDB.move( srcUrl, destUrl );
                            }
                        }
                    },
                
                    select: function ( element ) {
                        Editor.Selection.selectAsset(element.userId, true, true);
                    },
                
                    clearSelect: function () {
                        Editor.Selection.clearAsset();
                        this.activeElement = null;
                        this.shiftStartElement = null;
                    },
                
                    selectingAction: function (event) {
                        event.stopPropagation();
                        this.focus();
                
                        var shiftStartEL = this.shiftStartElement;
                        this.shiftStartElement = null;
                
                        if ( event.detail.shift ) {
                            if ( shiftStartEL === null ) {
                                shiftStartEL = this.activeElement;
                            }
                
                            this.shiftStartElement = shiftStartEL;
                
                            var el = this.shiftStartElement;
                            var userIds = [];
                
                            if ( shiftStartEL !== event.target ) {
                                if ( this.shiftStartElement.offsetTop &lt; event.target.offsetTop ) {
                                    while ( el !== event.target ) {
                                        userIds.push(el.userId);
                                        el = this.nextItem(el);
                                    }
                                }
                                else {
                                    while ( el !== event.target ) {
                                        userIds.push(el.userId);
                                        el = this.prevItem(el);
                                    }
                                }
                            }
                            userIds.push(event.target.userId);
                            Editor.Selection.selectAsset(userIds, true, false);
                        }
                        else if ( event.detail.toggle ) {
                            if ( event.target.selected ) {
                                Editor.Selection.unselectAsset(event.target.userId, false);
                            }
                            else {
                                Editor.Selection.selectAsset(event.target.userId, false, false);
                            }
                        }
                        else {
                            // if target already selected, do not unselect others
                            if ( !event.target.selected ) {
                                Editor.Selection.selectAsset(event.target.userId, true, false);
                            }
                        }
                    },
                
                    selectAction: function (event) {
                        event.stopPropagation();
                
                        if ( event.detail.shift ) {
                            Editor.Selection.confirm();
                        }
                        else if ( event.detail.toggle ) {
                            Editor.Selection.confirm();
                        }
                        else {
                            Editor.Selection.selectAsset(event.target.userId, true);
                        }
                    },
                
                    renameConfirmAction: function (event) {
                        event.stopPropagation();
                
                        var renamingEL = this.$.nameInput.renamingEL;
                
                        this.$.nameInput.style.display = &#x27;none&#x27;;
                        this.$.content.appendChild(this.$.nameInput);
                        this.$.nameInput.renamingEL = null;
                
                        // NOTE: the rename confirm will invoke focusoutAction
                        window.requestAnimationFrame( function () {
                            this.focus();
                        }.bind(this));
                
                        renamingEL._renaming = false;
                
                        if ( renamingEL.name !== event.target.value ) {
                            var srcUrl = this.getUrl(renamingEL);
                            var destUrl = Url.join( Url.dirname(srcUrl), event.target.value + renamingEL.extname );
                
                            if ( srcUrl.toLowerCase() === destUrl.toLowerCase() ) {
                                Fire.warn(&#x27;Renaming asset from lower case to upper case or vice verse will not be detected by Git.&#x27;);
                            }
                
                            Editor.AssetDB.move( srcUrl, destUrl );
                        }
                    },
                
                    openAction: function (event) {
                        event.stopPropagation();
                
                        if ( !(event.target instanceof AssetsItem) ) {
                            return;
                        }
                
                        Editor.sendToAll(&#x27;asset:open&#x27;, {
                            uuid: event.target.userId,
                            url: this.getUrl(event.target)
                        });
                    },
                
                    contextmenuAction: function (event) {
                        event.preventDefault();
                        event.stopPropagation();
                
                        // NOTE: without this, we will create new assets while watching ON
                        var Remote = require(&#x27;remote&#x27;);
                        Remote.getCurrentWindow().focus();
                
                        //
                        this.resetDragState();
                
                        //
                        var curContextID = Editor.UUID.AssetsRoot;
                        if ( event.target instanceof AssetsItem ) {
                            curContextID = event.target.userId;
                        }
                
                        Editor.Selection.setContextAsset(curContextID);
                
                        if (!this.contextmenu) {
                            this.createContextMenu();
                        }
                
                        this.contextmenu.popup(Remote.getCurrentWindow());
                    },
                
                    keydownAction: function (event) {
                        this.super([event]);
                        if (event.cancelBubble) {
                            return;
                        }
                
                        switch ( event.which ) {
                            // delete (Windows)
                            case 46:
                                this.deleteSelection();
                                event.stopPropagation();
                            break;
                
                            // command + delete (Mac)
                            case 8:
                                if ( event.metaKey ) {
                                    this.deleteSelection();
                                }
                                event.stopPropagation();
                            break;
                        }
                    },
                
                    dragstartAction: function ( event ) {
                        event.stopPropagation();
                
                        EditorUI.DragDrop.start( event.dataTransfer, &#x27;copyMove&#x27;, &#x27;asset&#x27;, Editor.Selection.assets.map(function (item) {
                            var uuid = item;
                            var itemEL = this.idToItem[uuid];
                            return { name: itemEL.name, id: item };
                        }.bind(this)) );
                    },
                
                    dragendAction: function (event) {
                        EditorUI.DragDrop.end();
                
                        this.resetDragState();
                        Editor.Selection.cancel();
                    },
                
                    dragoverAction: function (event) {
                        var dragType = EditorUI.DragDrop.type(event.dataTransfer);
                        if ( dragType !== &quot;file&quot; &amp;&amp; dragType !== &quot;asset&quot; ) {
                            EditorUI.DragDrop.allowDrop( event.dataTransfer, false );
                            return;
                        }
                
                        //
                        event.preventDefault();
                        event.stopPropagation();
                
                        //
                        if ( event.target ) {
                            this.lastDragoverEL = this.curDragoverEL;
                            var dragoverTraget = event.target;
                            if ( event.target.isFolder === false )
                                dragoverTraget = event.target.parentElement;
                
                            if ( event.target === this ) {
                                dragoverTraget = this.firstChild;
                            }
                
                            //
                            if ( dragoverTraget !== this.lastDragoverEL ) {
                                this.cancelHighligting();
                                this.cancelConflictsHighliting();
                                this.curDragoverEL = dragoverTraget;
                
                                this.highlightBorder(dragoverTraget);
                
                                // name collision check
                                var names = [];
                                var i = 0;
                                var dragItems = EditorUI.DragDrop.items(event.dataTransfer);
                
                                if ( dragType === &quot;file&quot; ) {
                                    for (i = 0; i &lt; dragItems.length; i++) {
                                        names.push(Path.basename(dragItems[i]));
                                    }
                                }
                                else if ( dragType === &quot;asset&quot; ) {
                                    var srcELs = this.getToplevelElements(dragItems);
                                    for (i = 0; i &lt; srcELs.length; i++) {
                                        var srcEL = srcELs[i];
                                        if (dragoverTraget !== srcEL.parentElement) {
                                            names.push(srcEL.name + srcEL.extname);
                                        }
                                    }
                                }
                
                                // check if we have conflicts names
                                var valid = true;
                                if ( names.length &gt; 0 ) {
                                    var collisions = _getNameCollisions( dragoverTraget, names );
                                    if ( collisions.length &gt; 0 ) {
                                        this.highlightConflicts(collisions);
                                        valid = false;
                                    }
                                }
                                EditorUI.DragDrop.allowDrop(event.dataTransfer, valid);
                            }
                
                            // highlight insert
                            var bounding = this.getBoundingClientRect();
                            var offsetY = event.clientY - bounding.top + this.scrollTop;
                            var position = &#x27;before&#x27;;
                            if ( offsetY &gt;= (event.target.offsetTop + event.target.offsetHeight * 0.5) )
                                position = &#x27;after&#x27;;
                            this.highlightInsert( event.target, dragoverTraget, position );
                        }
                
                        //
                        var dropEffect = &quot;none&quot;;
                        if ( dragType === &quot;file&quot; ) {
                            dropEffect = &quot;copy&quot;;
                        }
                        else if ( dragType === &quot;asset&quot; ) {
                            dropEffect = &quot;move&quot;;
                        }
                        EditorUI.DragDrop.updateDropEffect(event.dataTransfer, dropEffect);
                    },
                
                    dropAction: function ( event ) {
                        var dragType = EditorUI.DragDrop.type(event.dataTransfer);
                        if ( dragType !== &#x27;asset&#x27; &amp;&amp; dragType !== &#x27;entity&#x27; &amp;&amp; dragType !== &#x27;file&#x27; )
                            return;
                
                        event.preventDefault();
                        event.stopPropagation();
                
                        var items = EditorUI.DragDrop.drop(event.dataTransfer);
                        var targetEL = this.curDragoverEL;
                
                        this.resetDragState();
                        Editor.Selection.cancel();
                
                        if ( items.length &gt; 0 ) {
                            if ( dragType === &#x27;file&#x27; ) {
                                var dstUrl = this.getUrl(targetEL);
                                Editor.AssetDB.import( dstUrl, items );
                            }
                            else if ( dragType === &#x27;asset&#x27; ) {
                                this.moveAssets( targetEL, items );
                            }
                        }
                    },
                
                });
                
                    </pre>
                </div>
            </div>
        </div>

    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/vendor/jquery.min.js"></script>
<script src="../assets/js/jquery-offscreen-trigger.js"></script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
